#!/bin/sh
#
# bkctld is a shell script to create and manage a backup server which will
# handle the backup of many servers (clients).
#
# Author: Victor Laborie <vlaborie@evolix.fr>
# Contributor: Benoît Série <bserie@evolix.fr>, Gregory Colpart <reg@evolix.fr>, Romain Dessort <rdessort@evolix.fr>, Tristan Pilat <tpilat@evolix.fr>
# Licence: AGPLv3
#

set -u

[ "$(id -u)" -ne 0 ] && error "You need to be root to run ${0} !"

[ -d './lib' ] && LIBDIR='lib'
[ -d '/usr/lib/bkctld' ] && LIBDIR='/usr/lib/bkctld'
. "${LIBDIR}/config"

mkdir -p "${CONFDIR}" "${JAILDIR}" "${INCDIR}" "${INDEX_DIR}"
subcommand="${1:-}"
jail="${2:-}"
option="${3:-}"

[ -x "${LIBDIR}/bkctld-${subcommand}" ] || usage

case "${subcommand}" in
    "inc" | "rm" | "check" | "stats")
        "${LIBDIR}/bkctld-${subcommand}"
    ;;
        "init")
        "${LIBDIR}/bkctld-${subcommand}" "${jail}"
    ;;
    "key" | "port" | "ip")
        "${LIBDIR}/bkctld-params" "${jail}" "${subcommand}" "${option}"
    ;;
    "start" | "stop" | "reload" | "restart" | "sync" | "update" | "remove")
    if [ "${jail}" = "all" ]; then
        jails=$(ls "${JAILDIR}")
        for jail in ${jails}; do
            case "${subcommand}" in
                "start")
                    check_jail_on "${jail}" || "${LIBDIR}/bkctld-${subcommand}" "${jail}"
                ;;
                "stop" | "reload" | "restart")
                    check_jail_on "${jail}" && "${LIBDIR}/bkctld-${subcommand}" "${jail}"
                ;;
                *)
                    "${LIBDIR}/bkctld-${subcommand}" "${jail}"
                ;;
            esac
                done
    else
        "${LIBDIR}/bkctld-${subcommand}" "${jail}"
    fi
    ;;
    "status")
    if [ -z "${jail}" ]; then
        jails=$(ls "${JAILDIR}")
        for jail in ${jails}; do
            "${LIBDIR}/bkctld-${subcommand}" "${jail}"
        done
    else
        "${LIBDIR}/bkctld-${subcommand}" "${jail}"
    fi
    ;;
esac
